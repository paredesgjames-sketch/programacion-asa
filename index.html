<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programaci√≥n de Personal - ASA 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #1a1a2e; font-size: 9px; }
        
        .header { 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
            color: #fff; padding: 6px 12px; position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-content { max-width: 1920px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
        .brand { display: flex; align-items: center; gap: 8px; }
        .brand-logo { 
            width: 42px; height: 28px; background: linear-gradient(135deg, #10b981, #059669); 
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 9px;
        }
        .brand-title { font-size: 12px; font-weight: 700; letter-spacing: 1px; }
        .brand-subtitle { font-size: 8px; opacity: 0.7; }
        
        .header-actions { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
        
        .icon-btn {
            width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease; position: relative;
        }
        .icon-btn:hover { transform: translateY(-1px); }
        .icon-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .icon-btn svg { width: 14px; height: 14px; }
        
        .icon-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
            background: #1a1a2e; color: #fff; padding: 3px 6px; border-radius: 3px;
            font-size: 8px; white-space: nowrap; z-index: 100;
        }
        
        .btn-folder { background: #3b82f6; color: #fff; }
        .btn-save { background: #10b981; color: #fff; }
        .btn-excel { background: #22c55e; color: #fff; }
        .btn-delete { background: #ef4444; color: #fff; }
        .btn-refresh { background: #8b5cf6; color: #fff; }
        .btn-undo { background: #6366f1; color: #fff; }
        .btn-redo { background: #8b5cf6; color: #fff; }
        
        .user-input {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 5px 8px; border-radius: 6px; font-size: 9px; width: 100px;
        }
        .user-input::placeholder { color: rgba(255,255,255,0.5); }
        
        .container { max-width: 1920px; margin: 0 auto; padding: 8px; }
        
        .toolbar { 
            background: #fff; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06); flex-wrap: wrap; gap: 8px;
        }
        .toolbar-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        
        .semana-picker { display: flex; align-items: center; gap: 6px; }
        .semana-picker label { font-weight: 600; color: #64748b; font-size: 9px; }
        .semana-picker input[type="date"] { display: none; }
        
        .semana-nav { display: flex; align-items: center; gap: 4px; }
        .semana-nav .btn-nav {
            width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            background: #e2e8f0; color: #1a1a2e; font-weight: 700; font-size: 14px;
            transition: all 0.2s;
        }
        .semana-nav .btn-nav:hover { background: #1a1a2e; color: #fff; }
        .semana-nav .semana-display {
            min-width: 180px; text-align: center; padding: 6px 12px;
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 6px;
            font-size: 10px; font-weight: 600; color: #1a1a2e;
        }
        .semana-nav .semana-display .sem-num { color: #10b981; font-weight: 700; }
        .semana-nav .semana-display .sem-rango { color: #64748b; font-size: 9px; }
        
        .stats { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .stat { background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 6px 12px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; min-width: 70px; }
        .stat-value { font-size: 16px; font-weight: 700; color: #1a1a2e; }
        .stat-label { font-size: 7px; color: #64748b; text-transform: uppercase; }
        .stat.highlight { background: linear-gradient(135deg, #10b981, #059669); border: none; }
        .stat.highlight .stat-value, .stat.highlight .stat-label { color: #fff; }
        
        .btn-search-toggle {
            background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: none; border-radius: 6px; 
            padding: 8px 12px; cursor: pointer; font-size: 9px; font-weight: 600;
            display: flex; align-items: center; gap: 4px; transition: all 0.2s;
        }
        .btn-search-toggle:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

        .status-badge {
            display: flex; align-items: center; gap: 4px; padding: 4px 8px;
            border-radius: 12px; font-size: 8px; font-weight: 600;
        }
        .status-badge.online { background: #d1fae5; color: #065f46; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        .status-badge.loading { background: #e0e7ff; color: #3730a3; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-badge.online .status-dot { background: #10b981; animation: pulse 2s infinite; }
        .status-badge.offline .status-dot { background: #ef4444; }
        .status-badge.loading .status-dot { background: #6366f1; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .alert-box {
            border-radius: 6px; padding: 8px 12px; margin-bottom: 8px;
            display: none; align-items: center; gap: 8px;
        }
        .alert-box.show { display: flex; }
        .alert-box.warning { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; }
        .alert-box .alert-icon { font-size: 16px; }
        .alert-box .alert-text { flex: 1; }
        .alert-box .alert-title { font-weight: 700; font-size: 10px; }
        .alert-box .alert-msg { font-size: 8px; opacity: 0.8; }
        
        .table-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .table-scroll { overflow-x: auto; max-height: calc(100vh - 200px); }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { 
            background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; 
            padding: 6px 3px; text-align: center; font-size: 8px; font-weight: 600; 
            text-transform: uppercase; position: sticky; top: 0; z-index: 10;
        }
        th.col-text { text-align: left; padding-left: 6px; }
        th .dia-fecha { font-size: 11px; font-weight: 700; }
        th .dia-nombre { font-size: 7px; opacity: 0.7; }
        
        td { padding: 3px 2px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        tr.duplicated td { background: #fed7aa !important; }
        tr.duplicated:hover td { background: #fdba74 !important; }
        .dup-badge { background: #ea580c; color: #fff; font-size: 6px; padding: 1px 3px; border-radius: 3px; margin-left: 2px; }
        
        tr.incomplete td { background: #fee2e2 !important; }
        tr.incomplete:hover td { background: #fecaca !important; }
        tr.incomplete select.cell-sel { border-color: #ef4444; background: #fef2f2; }
        .incomplete-badge { background: #ef4444; color: #fff; font-size: 6px; padding: 1px 3px; border-radius: 3px; margin-left: 2px; }
        
        tr.no-personal td { background: #fef3c7 !important; }
        tr.no-personal:hover td { background: #fde68a !important; }
        .no-personal-badge { background: #f59e0b; color: #fff; font-size: 6px; padding: 1px 3px; border-radius: 3px; margin-left: 2px; }
        
        tr.obsoleta td { background: #f3e8ff !important; }
        tr.obsoleta:hover td { background: #e9d5ff !important; }
        tr.obsoleta select.cell-sel { border-color: #9333ea; background: #faf5ff; }
        .obsoleta-badge { background: #9333ea; color: #fff; font-size: 6px; padding: 1px 3px; border-radius: 3px; margin-left: 2px; animation: pulse 1s infinite; }
        
        tr.area-row td { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; font-weight: 600; padding: 5px 8px; font-size: 9px; }
        
        tr.subtotal-row td { background: linear-gradient(135deg, #e0f2fe, #bae6fd); font-weight: 600; font-size: 8px; border-top: 1px solid #0ea5e9; }
        .subtot-num { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 9px; display: inline-block; min-width: 24px; text-align: center; }
        
        tr.total-row td { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; font-weight: 700; font-size: 9px; }
        .total-num { background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 10px; display: inline-block; min-width: 28px; text-align: center; }
        
        select.cell-sel { width: 100%; padding: 3px 2px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        select.cell-sel.labor-sel { font-weight: 700; }
        select.cell-sel:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }
        select.cell-sel.dup-select { border-color: #f59e0b; background: #fffbeb; }
        
        .turno-sel { padding: 3px 5px; border-radius: 4px; border: 1px solid transparent; font-size: 8px; font-weight: 600; cursor: pointer; }
        .t-dia { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .t-tarde { background: #fed7aa; color: #c2410c; border-color: #fb923c; }
        .t-noche { background: #1e293b; color: #fff; border-color: #334155; }
        
        .day-cell { text-align: center; width: 36px; min-width: 36px; padding: 2px 1px !important; }
        .day-input { width: 32px; height: 24px; padding: 0; font-size: 10px; text-align: center; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; background: #f8fafc; transition: all 0.2s; }
        .day-input:focus { outline: none; border-color: #10b981; background: #fff; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }
        .day-input.has-value { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; border-color: #1a1a2e; }
        .day-input.has-value.tarde { background: linear-gradient(135deg, #ea580c, #c2410c); border-color: #ea580c; }
        .day-input.has-value.noche { background: linear-gradient(135deg, #0f172a, #1e293b); border-color: #0f172a; }
        .day-input.finde { background: #fef9c3; border-color: #fcd34d; }
        .day-input.finde.has-value { background: linear-gradient(135deg, #f59e0b, #d97706); border-color: #f59e0b; color: #fff; }
        
        .tot-badge { background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 3px 6px; border-radius: 4px; font-weight: 700; font-size: 9px; }
        .cc-cell { font-family: 'Consolas', monospace; font-size: 7px; color: #64748b; max-width: 50px; overflow: hidden; text-overflow: ellipsis; }
        .new-badge { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: #fff; font-size: 6px; padding: 1px 3px; border-radius: 3px; margin-left: 2px; }
        
        .row-actions { display: flex; gap: 2px; justify-content: center; }
        .btn-row { width: 20px; height: 20px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-row:hover { transform: scale(1.1); }
        .btn-row svg { width: 10px; height: 10px; }
        .btn-dup { background: #3b82f6; color: #fff; }
        .btn-del { background: #ef4444; color: #fff; }
        
        .add-row { width: 100%; padding: 10px; border: 2px dashed #cbd5e1; background: #f8fafc; cursor: pointer; color: #64748b; font-size: 10px; font-weight: 600; border-radius: 0 0 8px 8px; transition: all 0.2s; }
        .add-row:hover { border-color: #10b981; color: #10b981; background: #f0fdf4; }
        
        .empty { text-align: center; padding: 30px; color: #64748b; }
        .empty-icon { font-size: 36px; margin-bottom: 8px; }
        
        .col-fundo { width: 90px; }
        .col-cultivo { width: 80px; }
        .col-area { width: 100px; }
        .col-grupo { width: 110px; }
        .col-labor { width: 150px; }
        .col-cc { width: 45px; }
        .col-turno { width: 50px; }
        .col-total { width: 40px; text-align: center; }
        .col-actions { width: 45px; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-bg.open { display: flex; }
        .modal { background: #fff; border-radius: 12px; padding: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 14px; color: #1a1a2e; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .modal-field { margin-bottom: 10px; }
        .modal-field label { display: block; font-size: 8px; font-weight: 600; color: #64748b; margin-bottom: 3px; }
        .modal-field input, .modal-field select { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 10px; }
        .modal-field .input-with-btn { display: flex; gap: 4px; }
        .modal-field .btn-toggle { padding: 8px; background: #3b82f6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }
        .modal-actions .btn { padding: 8px 14px; border-radius: 6px; font-size: 10px; font-weight: 600; border: none; cursor: pointer; }
        .modal-actions .btn-cancel { background: #f1f5f9; color: #64748b; }
        .modal-actions .btn-confirm { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
        
        .confirm-dialog { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .confirm-dialog.open { display: flex; }
        .confirm-box { background: #fff; border-radius: 12px; padding: 20px; width: 90%; max-width: 320px; text-align: center; }
        .confirm-icon { font-size: 36px; margin-bottom: 12px; }
        .confirm-title { font-size: 14px; font-weight: 700; color: #1a1a2e; margin-bottom: 6px; }
        .confirm-msg { font-size: 10px; color: #64748b; margin-bottom: 16px; }
        .confirm-actions { display: flex; gap: 8px; justify-content: center; }
        .confirm-actions .btn { padding: 8px 18px; border-radius: 6px; font-size: 10px; font-weight: 600; border: none; cursor: pointer; }
        .confirm-actions .btn-no { background: #f1f5f9; color: #64748b; }
        .confirm-actions .btn-yes { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; }
        .confirm-actions .btn-yes.green { background: linear-gradient(135deg, #10b981, #059669); }
        
        .file-input { display: none; }
        
        .loading-overlay {
            display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            z-index: 4000; align-items: center; justify-content: center; flex-direction: column;
        }
        .loading-overlay.show { display: flex; }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid #e2e8f0;
            border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 12px; font-size: 12px; color: #64748b; }
        
        .search-box {
            background: #fff; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06); display: none;
        }
        .search-box.show { display: block; }
        .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .search-header h4 { font-size: 11px; color: #1a1a2e; display: flex; align-items: center; gap: 6px; }
        .search-close { background: #ef4444; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 9px; }
        .search-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .search-filters select, .search-filters input { padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 9px; min-width: 120px; }
        .search-filters input { min-width: 180px; }
        .search-filters .btn-search { background: linear-gradient(135deg, #10b981, #059669); color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 9px; font-weight: 600; }
        .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; }
        .search-results table { width: 100%; border-collapse: collapse; font-size: 8px; }
        .search-results th { background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 6px 4px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .search-results td { padding: 5px 4px; border-bottom: 1px solid #f1f5f9; }
        .search-results tr:hover td { background: #f0fdf4; }
        .search-results .btn-add { background: linear-gradient(135deg, #10b981, #059669); color: #fff; border: none; border-radius: 4px; padding: 3px 8px; cursor: pointer; font-size: 8px; }
        .search-count { font-size: 8px; color: #64748b; margin-top: 6px; }
        
        .toast-container { position: fixed; top: 60px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast {
            background: #fff; border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 10px; min-width: 280px; max-width: 400px;
            animation: slideIn 0.3s ease; border-left: 4px solid #10b981;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast.info { border-left-color: #3b82f6; }
        .toast-icon { font-size: 20px; }
        .toast-content { flex: 1; }
        .toast-title { font-size: 11px; font-weight: 700; color: #1a1a2e; }
        .toast-msg { font-size: 9px; color: #64748b; margin-top: 2px; }
        .toast-close { background: none; border: none; font-size: 16px; cursor: pointer; color: #94a3b8; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .autosave-indicator {
            position: fixed; bottom: 20px; right: 20px; background: #10b981; color: #fff;
            padding: 8px 12px; border-radius: 20px; font-size: 9px; font-weight: 600;
            display: none; align-items: center; gap: 6px; z-index: 1000;
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }
        .autosave-indicator.show { display: flex; }
        .autosave-indicator.saving { background: #f59e0b; }
        
        .shortcuts-hint {
            position: fixed; bottom: 20px; left: 20px; background: rgba(26,26,46,0.9); color: #fff;
            padding: 8px 12px; border-radius: 8px; font-size: 8px; z-index: 1000;
        }
        .shortcuts-hint kbd { background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px; margin: 0 2px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando maestro de labores...</div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="autosave-indicator" id="autosaveIndicator">
        <span>üíæ</span> <span id="autosaveText">Guardado autom√°tico</span>
    </div>
    
    <div class="shortcuts-hint">
        <kbd>Ctrl</kbd>+<kbd>S</kbd> Guardar &nbsp; <kbd>Ctrl</kbd>+<kbd>E</kbd> Excel &nbsp; <kbd>Ctrl</kbd>+<kbd>F</kbd> Buscar &nbsp; <kbd>Ctrl</kbd>+<kbd>Z</kbd> Deshacer &nbsp; <kbd>Ctrl</kbd>+<kbd>Y</kbd> Rehacer
    </div>

    <header class="header">
        <div class="header-content">
            <div class="brand">
                <div class="brand-logo">ASA-IA</div>
                <div>
                    <div class="brand-title">PROGRAMACI√ìN DE PERSONAL</div>
                    <div class="brand-subtitle">Control Presupuestal</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-badge loading" id="statusBadge">
                    <div class="status-dot"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <input type="text" class="user-input" id="userName" placeholder="üë§ Tu nombre...">
                <input type="file" class="file-input" id="fileLoad" accept=".json" onchange="cargarArchivo(event)">
                
                <button class="icon-btn btn-undo" id="btnUndo" data-tooltip="Deshacer (Ctrl+Z)" onclick="deshacer()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                </button>
                <button class="icon-btn btn-redo" id="btnRedo" data-tooltip="Rehacer (Ctrl+Y)" onclick="rehacer()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path></svg>
                </button>
                <button class="icon-btn btn-refresh" data-tooltip="Actualizar MAESTRO" onclick="cargarMaestro()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                </button>
                <button class="icon-btn btn-folder" data-tooltip="Cargar archivo" onclick="document.getElementById('fileLoad').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                </button>
                <button class="icon-btn btn-save" data-tooltip="Guardar (Ctrl+S)" onclick="guardarArchivo()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </button>
                <button class="icon-btn btn-excel" data-tooltip="Exportar Excel (Ctrl+E)" onclick="exportarExcel()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8ZM15.8,20H14l-2-3.4L10,20H8.2l2.9-4.5L8.4,11H10l1.9,3.2L13.8,11h1.8l-2.9,4.5ZM13,9V3.5L18.5,9Z"/></svg>
                </button>
                <button class="icon-btn btn-delete" data-tooltip="Borrar todo" onclick="confirmarBorrarTodo()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="semana-picker">
                    <label>üìÖ</label>
                    <input type="date" id="fechaInicio" onchange="actualizarSemana()">
                    <div class="semana-nav">
                        <button class="btn-nav" onclick="cambiarSemana(-1)" title="Semana anterior">‚óÄ</button>
                        <div class="semana-display">
                            <span class="sem-num" id="semanaNum">Semana 8</span>
                            <br>
                            <span class="sem-rango" id="semanaRango">17 Feb - 23 Feb 2026</span>
                        </div>
                        <button class="btn-nav" onclick="cambiarSemana(1)" title="Semana siguiente">‚ñ∂</button>
                    </div>
                </div>
            </div>
            <div class="stats">
                <button class="btn-search-toggle" onclick="toggleSearch()">üîç Buscar Labor</button>
                <div class="stat"><div class="stat-value" id="statLabores">0</div><div class="stat-label">Labores</div></div>
                <div class="stat highlight"><div class="stat-value" id="statPersonal">0</div><div class="stat-label">Personal</div></div>
                <div class="stat"><div class="stat-value" id="statMaestro">0</div><div class="stat-label">Maestro</div></div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-box" id="searchBox">
            <div class="search-header">
                <h4>üîç Buscar Labor en MAESTRO</h4>
                <button class="search-close" onclick="toggleSearch()">‚úï Cerrar</button>
            </div>
            <div class="search-filters">
                <select id="searchFundo" onchange="updateSearchFilters()"><option value="">-- Todos los Fundos --</option></select>
                <select id="searchArea" onchange="buscarLabores()"><option value="">-- Todas las √Åreas --</option></select>
                <input type="text" id="searchText" placeholder="Buscar por nombre de labor..." onkeyup="buscarLabores()">
                <button class="btn-search" onclick="buscarLabores()">Buscar</button>
            </div>
            <div class="search-results">
                <table><thead><tr><th>Fundo</th><th>Cultivo</th><th>√Årea</th><th>Grupo Labor</th><th>Labor</th><th>CC</th><th></th></tr></thead>
                <tbody id="searchResultsBody"><tr><td colspan="7" style="text-align:center;color:#64748b;padding:20px;">Ingrese filtros</td></tr></tbody></table>
            </div>
            <div class="search-count" id="searchCount"></div>
        </div>
        
        <!-- Alerts -->
        <div class="alert-box warning" id="alertDuplicates"><div class="alert-icon">‚ö†Ô∏è</div><div class="alert-text"><div class="alert-title">Labores duplicadas</div><div class="alert-msg" id="alertDupMsg"></div></div></div>
        <div class="alert-box warning" id="alertIncomplete" style="border-color:#ef4444;background:linear-gradient(135deg,#fee2e2,#fecaca);"><div class="alert-icon">‚ùå</div><div class="alert-text"><div class="alert-title" style="color:#991b1b;">Labores incompletas</div><div class="alert-msg" id="alertIncMsg" style="color:#b91c1c;"></div></div></div>
        <div class="alert-box warning" id="alertNoPersonal" style="border-color:#f59e0b;"><div class="alert-icon">üë•</div><div class="alert-text"><div class="alert-title" style="color:#92400e;">Sin personal</div><div class="alert-msg" id="alertNoPerMsg" style="color:#a16207;"></div></div></div>
        <div class="alert-box warning" id="alertObsoletas" style="border-color:#9333ea;background:linear-gradient(135deg,#f3e8ff,#e9d5ff);"><div class="alert-icon">üîÑ</div><div class="alert-text"><div class="alert-title" style="color:#6b21a8;">Labores desactualizadas</div><div class="alert-msg" id="alertObsMsg" style="color:#7c3aed;"></div></div></div>
        
        <!-- Main Table -->
        <div class="table-card">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th class="col-text col-fundo">Fundo</th>
                            <th class="col-text col-cultivo">Cultivo</th>
                            <th class="col-text col-area">√Årea</th>
                            <th class="col-text col-grupo">Grupo Labor</th>
                            <th class="col-text col-labor">Labor</th>
                            <th class="col-cc">CC</th>
                            <th class="col-turno">Turno</th>
                            <th class="day-cell" id="th-lun"><div class="dia-nombre">LUN</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-mar"><div class="dia-nombre">MAR</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-mie"><div class="dia-nombre">MIE</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-jue"><div class="dia-nombre">JUE</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-vie"><div class="dia-nombre">VIE</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-sab"><div class="dia-nombre">SAB</div><div class="dia-fecha">-</div></th>
                            <th class="day-cell" id="th-dom"><div class="dia-nombre">DOM</div><div class="dia-fecha">-</div></th>
                            <th class="col-total">Total</th>
                            <th class="col-actions"></th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <button class="add-row" onclick="agregarFila()">+ Agregar Nueva Labor</button>
        </div>
    </div>
    
    <!-- Modal Nueva Labor -->
    <div class="modal-bg" id="modalNueva">
        <div class="modal">
            <h3>‚ûï Crear Nueva Labor</h3>
            <input type="hidden" id="modalIdx">
            <div class="modal-field"><label>Fundo</label><select id="mFundo" onchange="mActCultivos()"></select></div>
            <div class="modal-field"><label>Cultivo</label><select id="mCultivo" onchange="mActAreas()"></select></div>
            <div class="modal-field"><label>√Årea</label><select id="mArea" onchange="mActGrupos()"></select></div>
            <div class="modal-field"><label>Grupo Labor</label><div class="input-with-btn"><select id="mGrupo"></select><input type="text" id="mGrupoNuevo" placeholder="Nuevo..." style="display:none;"><button type="button" class="btn-toggle" onclick="toggleGrupoInput()">+</button></div></div>
            <div class="modal-field"><label>Nombre de la Labor</label><input type="text" id="mNombre" placeholder="Ingrese el nombre"></div>
            <div class="modal-actions"><button class="btn btn-cancel" onclick="cerrarModal()">Cancelar</button><button class="btn btn-confirm" onclick="crearLabor()">Crear</button></div>
        </div>
    </div>
    
    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-box">
            <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
            <div class="confirm-title" id="confirmTitle">Confirmar</div>
            <div class="confirm-msg" id="confirmMsg">¬øEst√° seguro?</div>
            <div class="confirm-actions"><button class="btn btn-no" onclick="cerrarConfirm()">No</button><button class="btn btn-yes" id="confirmYes">S√≠</button></div>
        </div>
    </div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtOqg02IGvkLp1AZGLwgKLV4mMJjxneSZdkXSnKQ1zwLFWP6v979iEbDu6aFotMg/pub?gid=1733470180&single=true&output=csv';

let MAESTRO = [];
let progs = [];
let laboresCustom = [];
let diasSemana = [];
let semanaActual = 1;
let anioActual = new Date().getFullYear();
const DIAS = ['LUN','MAR','MIE','JUE','VIE','SAB','DOM'];

// Historial para Ctrl+Z / Ctrl+Y
let historial = [];
let historialPos = -1;
const MAX_HISTORIAL = 50;

document.addEventListener('DOMContentLoaded', () => {
    const hoy = new Date();
    const lun = new Date(hoy);
    lun.setDate(hoy.getDate() - (hoy.getDay() === 0 ? 6 : hoy.getDay() - 1));
    document.getElementById('fechaInicio').value = lun.toISOString().split('T')[0];
    actualizarSemana();
    cargarMaestro();
    cargarAutoGuardado();
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 's') { e.preventDefault(); guardarArchivo(); }
            if (e.key === 'e') { e.preventDefault(); exportarExcel(); }
            if (e.key === 'f') { e.preventDefault(); toggleSearch(); }
            if (e.key === 'z') { e.preventDefault(); deshacer(); }
            if (e.key === 'y') { e.preventDefault(); rehacer(); }
        }
    });
    
    // Auto-guardar al salir de la p√°gina
    window.addEventListener('beforeunload', () => { guardarEnLocal(); });
    
    // Auto-guardar cuando se pierde conexi√≥n
    window.addEventListener('offline', () => {
        guardarEnLocal();
        showToast('Sin conexi√≥n', 'Datos guardados localmente', 'warning');
    });
    
    window.addEventListener('online', () => {
        showToast('Conectado', 'Conexi√≥n restaurada', 'success');
    });
});

// ========== HISTORIAL (Ctrl+Z / Ctrl+Y) ==========
function guardarEstado() {
    // Eliminar estados futuros si estamos en medio del historial
    if (historialPos < historial.length - 1) {
        historial = historial.slice(0, historialPos + 1);
    }
    
    // Guardar estado actual
    const estado = JSON.stringify({ progs, laboresCustom });
    historial.push(estado);
    
    // Limitar historial
    if (historial.length > MAX_HISTORIAL) {
        historial.shift();
    } else {
        historialPos++;
    }
    
    actualizarBotonesHistorial();
    guardarEnLocal();
}

function deshacer() {
    if (historialPos > 0) {
        historialPos--;
        restaurarEstado();
        showToast('Deshacer', 'Acci√≥n deshecha', 'info');
    }
}

function rehacer() {
    if (historialPos < historial.length - 1) {
        historialPos++;
        restaurarEstado();
        showToast('Rehacer', 'Acci√≥n rehecha', 'info');
    }
}

function restaurarEstado() {
    const estado = JSON.parse(historial[historialPos]);
    progs = estado.progs;
    laboresCustom = estado.laboresCustom;
    actualizarBotonesHistorial();
    renderSinHistorial();
}

function actualizarBotonesHistorial() {
    document.getElementById('btnUndo').disabled = historialPos <= 0;
    document.getElementById('btnRedo').disabled = historialPos >= historial.length - 1;
}

function renderSinHistorial() {
    renderInterno();
}

// ========== AUTO-GUARDADO ==========
function guardarEnLocal() {
    const data = { 
        progs, 
        laboresCustom, 
        semana: semanaActual, 
        anio: anioActual, 
        usuario: document.getElementById('userName').value,
        fecha: new Date().toISOString()
    };
    localStorage.setItem('asa_programacion', JSON.stringify(data));
    
    const indicator = document.getElementById('autosaveIndicator');
    indicator.classList.add('show');
    document.getElementById('autosaveText').textContent = 'Guardado';
    setTimeout(() => indicator.classList.remove('show'), 2000);
}

function cargarAutoGuardado() {
    const saved = localStorage.getItem('asa_programacion');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.progs && data.progs.length > 0) {
                progs = data.progs;
                laboresCustom = data.laboresCustom || [];
                if (data.usuario) document.getElementById('userName').value = data.usuario;
                
                // Guardar estado inicial en historial
                historial = [JSON.stringify({ progs, laboresCustom })];
                historialPos = 0;
                
                showToast('Datos recuperados', `${progs.length} labores cargadas`, 'info');
            }
        } catch(e) {}
    }
}

// ========== TOAST ==========
function showToast(title, msg, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    toast.innerHTML = `<div class="toast-icon">${icons[type]}</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// ========== SEMANA ==========
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function cambiarSemana(direccion) {
    const fi = document.getElementById('fechaInicio').value;
    if (!fi) return;
    const f = new Date(fi + 'T00:00:00');
    f.setDate(f.getDate() + (direccion * 7));
    document.getElementById('fechaInicio').value = f.toISOString().split('T')[0];
    actualizarSemana();
}

function actualizarSemana() {
    const fi = document.getElementById('fechaInicio').value;
    if (!fi) return;
    let f = new Date(fi + 'T00:00:00');
    
    const dia = f.getDay();
    if (dia !== 1) {
        const diff = dia === 0 ? -6 : 1 - dia;
        f.setDate(f.getDate() + diff);
        document.getElementById('fechaInicio').value = f.toISOString().split('T')[0];
    }
    
    semanaActual = getWeekNumber(f);
    anioActual = f.getFullYear();
    document.getElementById('semanaNum').textContent = `Semana ${semanaActual}`;
    
    diasSemana = [];
    const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    
    for (let i = 0; i < 7; i++) {
        const d = new Date(f); d.setDate(f.getDate() + i);
        diasSemana.push({ nom: DIAS[i], num: d.getDate(), mes: meses[d.getMonth()], str: d.toISOString().split('T')[0], fin: i >= 5 });
        const th = document.getElementById('th-' + DIAS[i].toLowerCase());
        if (th) th.querySelector('.dia-fecha').textContent = d.getDate();
    }
    
    const ult = new Date(f); ult.setDate(f.getDate() + 6);
    document.getElementById('semanaRango').textContent = f.getDate() + ' ' + meses[f.getMonth()] + ' - ' + ult.getDate() + ' ' + meses[ult.getMonth()] + ' ' + ult.getFullYear();
    renderSinHistorial();
}

// ========== MAESTRO ==========
async function cargarMaestro() {
    const loading = document.getElementById('loadingOverlay');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    
    loading.classList.add('show');
    statusBadge.className = 'status-badge loading';
    statusText.textContent = 'Actualizando...';
    
    try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error('Error');
        const csvText = await response.text();
        MAESTRO = parseCSV(csvText);
        
        document.getElementById('statMaestro').textContent = MAESTRO.length;
        statusBadge.className = 'status-badge online';
        statusText.textContent = `Conectado (${MAESTRO.length})`;
        
        renderSinHistorial();
        showToast('MAESTRO actualizado', `${MAESTRO.length} labores disponibles`, 'success');
    } catch (error) {
        statusBadge.className = 'status-badge offline';
        statusText.textContent = 'Sin conexi√≥n';
        showToast('Error', 'No se pudo actualizar el MAESTRO', 'error');
    }
    
    loading.classList.remove('show');
}

function parseCSV(csv) {
    const lines = csv.split('\n');
    const headers = parseCSVLine(lines[0]);
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => row[h.trim()] = (values[idx] || '').trim());
        data.push(row);
    }
    return data;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (const char of line) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { result.push(current); current = ''; }
        else current += char;
    }
    result.push(current);
    return result;
}

function getData() { return [...MAESTRO, ...laboresCustom]; }

function getOpts(tipo, flt = {}) {
    let d = getData();
    if (flt.fundo) d = d.filter(r => r.Fundo === flt.fundo);
    if (flt.cultivo) d = d.filter(r => (r.CULTIVO || r.Cultivo) === flt.cultivo);
    if (flt.area) d = d.filter(r => r.AREA === flt.area);
    if (flt.grupo) d = d.filter(r => r['Grupo Labor'] === flt.grupo);
    if (tipo === 'cultivo') return [...new Set(d.map(r => r.CULTIVO || r.Cultivo))].filter(Boolean).sort();
    const colMap = {fundo:'Fundo', area:'AREA', grupo:'Grupo Labor', labor:'Labor'};
    return [...new Set(d.map(r => r[colMap[tipo]]))].filter(Boolean).sort();
}

// ========== DETECCIONES ==========
function detectarDuplicados() {
    const keys = {}, duplicados = new Set();
    progs.forEach((p, i) => {
        if (p.fundo && p.area && p.grupo && p.labor && p.turno) {
            const key = `${p.fundo}|${p.cultivo}|${p.area}|${p.grupo}|${p.labor}|${p.turno}`;
            if (keys[key] !== undefined) { duplicados.add(keys[key]); duplicados.add(i); }
            else keys[key] = i;
        }
    });
    return duplicados;
}

function detectarIncompletos() {
    const incompletos = new Set();
    progs.forEach((p, i) => { if (!p.fundo || !p.cultivo || !p.area || !p.grupo || !p.labor) incompletos.add(i); });
    return incompletos;
}

function detectarSinPersonal() {
    const sinPersonal = new Set();
    progs.forEach((p, i) => {
        if (p.fundo && p.cultivo && p.area && p.grupo && p.labor) {
            let tiene = false;
            DIAS.forEach(d => { if (p.dias && p.dias[d] > 0) tiene = true; });
            if (!tiene) sinPersonal.add(i);
        }
    });
    return sinPersonal;
}

function detectarObsoletas() {
    const obsoletas = new Set(), detallesObsoletas = {};
    progs.forEach((p, i) => {
        if (p.fundo && p.labor && !p.esNueva) {
            const existe = MAESTRO.find(m => m.Fundo === p.fundo && m.Labor === p.labor);
            if (!existe) {
                obsoletas.add(i);
                detallesObsoletas[i] = { labor: p.labor, sugerencias: MAESTRO.filter(m => m.Fundo === p.fundo && m.AREA === p.area).map(m => m.Labor).slice(0,3) };
            }
        }
    });
    return { obsoletas, detallesObsoletas };
}

// ========== RENDER ==========
function render() {
    guardarEstado();
    renderInterno();
}

function renderInterno() {
    const tbody = document.getElementById('tbody');
    const duplicados = detectarDuplicados();
    const incompletos = detectarIncompletos();
    const sinPersonal = detectarSinPersonal();
    const { obsoletas, detallesObsoletas } = detectarObsoletas();
    
    document.getElementById('alertDuplicates').classList.toggle('show', duplicados.size > 0);
    document.getElementById('alertDupMsg').textContent = `${duplicados.size} duplicadas`;
    document.getElementById('alertIncomplete').classList.toggle('show', incompletos.size > 0);
    document.getElementById('alertIncMsg').textContent = `${incompletos.size} incompletas`;
    document.getElementById('alertNoPersonal').classList.toggle('show', sinPersonal.size > 0);
    document.getElementById('alertNoPerMsg').textContent = `${sinPersonal.size} sin personal`;
    document.getElementById('alertObsoletas').classList.toggle('show', obsoletas.size > 0);
    
    let totalGen = 0, totDia = {LUN:0,MAR:0,MIE:0,JUE:0,VIE:0,SAB:0,DOM:0};
    progs.forEach(p => DIAS.forEach(d => { const v = (p.dias && p.dias[d]) || 0; totalGen += v; totDia[d] += v; }));
    
    document.getElementById('statLabores').textContent = progs.length;
    document.getElementById('statPersonal').textContent = totalGen;
    
    if (progs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="16" class="empty"><div class="empty-icon">üìã</div><div>No hay labores</div><div style="font-size:8px;margin-top:6px;">Use üîç Buscar Labor o "+ Agregar Nueva Labor"</div></td></tr>';
        return;
    }
    
    const porArea = {};
    progs.forEach((p, i) => { const a = p.area || 'Sin √Årea'; if (!porArea[a]) porArea[a] = []; porArea[a].push({...p, _i: i}); });
    
    let html = '';
    Object.keys(porArea).sort().forEach(area => {
        const items = porArea[area];
        html += `<tr class="area-row"><td colspan="16">üìÅ ${area} (${items.length})</td></tr>`;
        
        let areaTot = {LUN:0,MAR:0,MIE:0,JUE:0,VIE:0,SAB:0,DOM:0}, areaSum = 0;
        
        items.forEach(p => {
            const i = p._i;
            const isDup = duplicados.has(i), isInc = incompletos.has(i), isNoPer = sinPersonal.has(i), isObs = obsoletas.has(i);
            let rowTot = 0;
            DIAS.forEach(d => { const v = (p.dias && p.dias[d]) || 0; rowTot += v; areaTot[d] += v; });
            areaSum += rowTot;
            
            let rowClass = isObs ? 'obsoleta' : isInc ? 'incomplete' : isNoPer ? 'no-personal' : isDup ? 'duplicated' : '';
            
            html += `<tr class="${rowClass}">`;
            html += `<td class="col-fundo">${selHTML(i,'fundo',p.fundo,getOpts('fundo'),isInc||isObs)}</td>`;
            html += `<td class="col-cultivo">${selHTML(i,'cultivo',p.cultivo,getOpts('cultivo',{fundo:p.fundo}),isInc||isObs)}</td>`;
            html += `<td class="col-area">${selHTML(i,'area',p.area,getOpts('area',{fundo:p.fundo,cultivo:p.cultivo}),isInc||isObs)}</td>`;
            html += `<td class="col-grupo">${selHTML(i,'grupo',p.grupo,getOpts('grupo',{fundo:p.fundo,cultivo:p.cultivo,area:p.area}),isInc||isObs)}</td>`;
            html += `<td class="col-labor">${selLaborHTML(i,p,isDup,isInc,isNoPer,isObs,detallesObsoletas[i])}</td>`;
            html += `<td class="cc-cell">${p.cc||'-'}</td>`;
            html += `<td class="col-turno">${turnoHTML(i,p.turno)}</td>`;
            
            DIAS.forEach((d, di) => {
                const v = (p.dias && p.dias[d]) || 0;
                let cls = 'day-input' + (di >= 5 ? ' finde' : '');
                if (v > 0) { cls += ' has-value'; if (p.turno==='TARDE') cls += ' tarde'; if (p.turno==='NOCHE') cls += ' noche'; }
                html += `<td class="day-cell"><input type="number" class="${cls}" data-row="${i}" data-col="${di}" data-dia="${d}" value="${v||''}" min="0" placeholder="-" oninput="guardarDia(this,${i},'${d}')" onfocus="this.select()" onkeydown="navegarInput(event,${i},${di})" onblur="actualizarAlSalir()"></td>`;
            });
            
            html += `<td class="col-total"><span class="tot-badge">${rowTot}</span></td>`;
            html += `<td class="col-actions"><div class="row-actions"><button class="btn-row btn-dup" onclick="duplicar(${i})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><button class="btn-row btn-del" onclick="confirmarEliminar(${i})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></td></tr>`;
        });
        
        html += `<tr class="subtotal-row"><td colspan="7" style="text-align:right;padding-right:8px;"><strong>Subtotal ${area}:</strong></td>`;
        DIAS.forEach(d => html += `<td class="day-cell"><span class="subtot-num">${areaTot[d]}</span></td>`);
        html += `<td class="col-total"><span class="subtot-num">${areaSum}</span></td><td></td></tr>`;
    });
    
    html += `<tr class="total-row"><td colspan="7" style="text-align:right;padding-right:8px;">üìä TOTAL:</td>`;
    DIAS.forEach(d => html += `<td class="day-cell"><span class="total-num">${totDia[d]}</span></td>`);
    html += `<td class="col-total"><span class="total-num">${totalGen}</span></td><td></td></tr>`;
    
    tbody.innerHTML = html;
}

function selHTML(i, tipo, val, opts, hl) {
    let h = `<select class="cell-sel${hl?' dup-select':''}" onchange="setVal(${i},'${tipo}',this.value)"><option value="">--</option>`;
    opts.forEach(o => h += `<option value="${o}"${o===val?' selected':''}>${o}</option>`);
    return h + '</select>';
}

function selLaborHTML(i, p, isDup, isInc, isNoPer, isObs, det) {
    const opts = getOpts('labor', {fundo:p.fundo, cultivo:p.cultivo, area:p.area, grupo:p.grupo});
    let cls = 'cell-sel labor-sel' + ((isObs||isInc||isDup) ? ' dup-select' : '');
    let h = `<select class="${cls}" onchange="setLabor(${i},this.value)"><option value="">--</option>`;
    if (isObs && p.labor) h += `<option value="${p.labor}" selected style="color:#9333ea;">‚ö†Ô∏è ${p.labor}</option>`;
    opts.forEach(o => h += `<option value="${o}"${o===p.labor && !isObs?' selected':''}>${o}</option>`);
    h += '<option value="__NEW__">‚ûï Nueva...</option></select>';
    if (p.esNueva) h += '<span class="new-badge">NUEVA</span>';
    if (isObs) h += '<span class="obsoleta-badge">ACTUALIZAR</span>';
    else if (isInc) h += '<span class="incomplete-badge">INCOMPLETA</span>';
    else if (isNoPer) h += '<span class="no-personal-badge">SIN PERSONAL</span>';
    else if (isDup) h += '<span class="dup-badge">DUPLICADA</span>';
    return h;
}

function turnoHTML(i, t) {
    t = t || 'DIA';
    const cls = t==='TARDE'?'t-tarde':(t==='NOCHE'?'t-noche':'t-dia');
    return `<select class="turno-sel ${cls}" onchange="setTurno(${i},this.value)"><option value="DIA"${t==='DIA'?' selected':''}>‚òÄÔ∏è</option><option value="TARDE"${t==='TARDE'?' selected':''}>üåÖ</option><option value="NOCHE"${t==='NOCHE'?' selected':''}>üåô</option></select>`;
}

function agregarFila() { progs.push({id:Date.now(), fundo:'', cultivo:'', area:'', grupo:'', labor:'', cc:'', turno:'DIA', dias:{}, esNueva:false}); render(); }
function duplicar(i) { const c = JSON.parse(JSON.stringify(progs[i])); c.id = Date.now(); progs.splice(i+1,0,c); render(); showToast('Duplicada', 'Labor duplicada', 'success'); }

function setVal(i, tipo, val) {
    progs[i][tipo] = val;
    if (tipo==='fundo') { progs[i].cultivo=''; progs[i].area=''; progs[i].grupo=''; progs[i].labor=''; progs[i].cc=''; }
    if (tipo==='cultivo') { progs[i].area=''; progs[i].grupo=''; progs[i].labor=''; progs[i].cc=''; }
    if (tipo==='area') { progs[i].grupo=''; progs[i].labor=''; progs[i].cc=''; }
    if (tipo==='grupo') { progs[i].labor=''; progs[i].cc=''; }
    progs[i].esNueva = false;
    render();
}

function setLabor(i, val) {
    if (val === '__NEW__') { abrirModal(i); return; }
    progs[i].labor = val;
    const dat = getData().find(r => r.Fundo===progs[i].fundo && (r.CULTIVO||r.Cultivo)===progs[i].cultivo && r.AREA===progs[i].area && r['Grupo Labor']===progs[i].grupo && r.Labor===val);
    if (dat) { progs[i].cc = dat.CodCentroCosto||''; progs[i].esNueva = dat._custom||false; }
    render();
}

function setTurno(i, v) { progs[i].turno = v; render(); }
function setDia(i, d, v) { if (!progs[i].dias) progs[i].dias = {}; progs[i].dias[d] = parseInt(v)||0; render(); }

// Guardar d√≠a sin re-renderizar (para navegaci√≥n fluida)
function guardarDia(input, row, dia) {
    const val = parseInt(input.value) || 0;
    if (!progs[row].dias) progs[row].dias = {};
    progs[row].dias[dia] = val;
    
    // Actualizar estilo visual
    input.classList.remove('has-value', 'tarde', 'noche');
    if (val > 0) {
        input.classList.add('has-value');
        if (progs[row].turno === 'TARDE') input.classList.add('tarde');
        if (progs[row].turno === 'NOCHE') input.classList.add('noche');
    }
    
    // Actualizar total en header
    let totalGen = 0;
    progs.forEach(p => DIAS.forEach(d => { totalGen += (p.dias && p.dias[d]) || 0; }));
    document.getElementById('statPersonal').textContent = totalGen;
    
    // Guardar silenciosamente
    guardarEnLocalSilencioso();
}

// Actualizar totales y subtotales al salir del input
function actualizarAlSalir() {
    // Solo actualizar si no estamos navegando
    setTimeout(() => {
        const activeEl = document.activeElement;
        if (!activeEl || !activeEl.classList.contains('day-input')) {
            renderSinHistorial();
        }
    }, 100);
}

function mostrarConfirm(icon, title, msg, onYes, green = false) {
    document.getElementById('confirmIcon').textContent = icon;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMsg').textContent = msg;
    const btn = document.getElementById('confirmYes');
    btn.className = 'btn btn-yes' + (green ? ' green' : '');
    btn.onclick = () => { cerrarConfirm(); onYes(); };
    document.getElementById('confirmDialog').classList.add('open');
}

function cerrarConfirm() { document.getElementById('confirmDialog').classList.remove('open'); }
function confirmarEliminar(i) { mostrarConfirm('üóëÔ∏è', '¬øEliminar?', `¬øEliminar "${progs[i].labor||'labor'}"?`, () => { progs.splice(i,1); render(); showToast('Eliminada', 'Labor eliminada', 'success'); }); }
function confirmarBorrarTodo() { if (!progs.length) return; mostrarConfirm('‚ö†Ô∏è', '¬øBorrar todo?', 'No se puede deshacer.', () => { progs=[]; render(); showToast('Borrado', 'Programaci√≥n borrada', 'warning'); }); }

let grupoInputMode = false;
function toggleGrupoInput() {
    grupoInputMode = !grupoInputMode;
    document.getElementById('mGrupo').style.display = grupoInputMode ? 'none' : 'block';
    document.getElementById('mGrupoNuevo').style.display = grupoInputMode ? 'block' : 'none';
    document.querySelector('.btn-toggle').textContent = grupoInputMode ? '‚åÑ' : '+';
}

function abrirModal(i) {
    document.getElementById('modalIdx').value = i;
    grupoInputMode = false;
    document.getElementById('mGrupo').style.display = 'block';
    document.getElementById('mGrupoNuevo').style.display = 'none';
    document.querySelector('.btn-toggle').textContent = '+';
    document.getElementById('mFundo').innerHTML = '<option value="">--</option>' + getOpts('fundo').map(f=>`<option>${f}</option>`).join('');
    mActCultivos();
    document.getElementById('mNombre').value = '';
    document.getElementById('mGrupoNuevo').value = '';
    document.getElementById('modalNueva').classList.add('open');
}

function mActCultivos() { document.getElementById('mCultivo').innerHTML = '<option value="">--</option>' + getOpts('cultivo',{fundo:document.getElementById('mFundo').value}).map(c=>`<option>${c}</option>`).join(''); mActAreas(); }
function mActAreas() { document.getElementById('mArea').innerHTML = '<option value="">--</option>' + getOpts('area',{fundo:document.getElementById('mFundo').value, cultivo:document.getElementById('mCultivo').value}).map(a=>`<option>${a}</option>`).join(''); mActGrupos(); }
function mActGrupos() { document.getElementById('mGrupo').innerHTML = '<option value="">--</option>' + getOpts('grupo',{fundo:document.getElementById('mFundo').value, cultivo:document.getElementById('mCultivo').value, area:document.getElementById('mArea').value}).map(g=>`<option>${g}</option>`).join(''); }
function cerrarModal() { document.getElementById('modalNueva').classList.remove('open'); renderSinHistorial(); }

function crearLabor() {
    const i = +document.getElementById('modalIdx').value;
    const fundo = document.getElementById('mFundo').value, cultivo = document.getElementById('mCultivo').value;
    const area = document.getElementById('mArea').value;
    const grupo = grupoInputMode ? document.getElementById('mGrupoNuevo').value.trim().toUpperCase() : document.getElementById('mGrupo').value;
    const nombre = document.getElementById('mNombre').value.trim().toUpperCase();
    if (!fundo||!cultivo||!area||!grupo||!nombre) { showToast('Error', 'Complete todos los campos', 'error'); return; }
    laboresCustom.push({Fundo:fundo, CULTIVO:cultivo, AREA:area, 'Grupo Labor':grupo, Labor:nombre, CodCentroCosto:'', _custom:true});
    progs[i].fundo=fundo; progs[i].cultivo=cultivo; progs[i].area=area; progs[i].grupo=grupo; progs[i].labor=nombre; progs[i].cc=''; progs[i].esNueva=true;
    cerrarModal();
    render();
    showToast('Creada', `Labor "${nombre}" creada`, 'success');
}

function guardarArchivo() {
    if (!progs.length) { showToast('Vac√≠o', 'No hay labores', 'warning'); return; }
    const dup = detectarDuplicados(), { obsoletas } = detectarObsoletas(), inc = detectarIncompletos(), sinP = detectarSinPersonal();
    if (dup.size > 0) { showToast('Error', `${dup.size} labores duplicadas`, 'error'); return; }
    if (obsoletas.size > 0) { showToast('Error', `${obsoletas.size} labores desactualizadas`, 'error'); return; }
    if (inc.size > 0) { showToast('Error', `${inc.size} labores incompletas`, 'error'); return; }
    if (sinP.size > 0) { showToast('Error', `${sinP.size} labores sin personal`, 'error'); return; }
    
    const n = document.getElementById('userName').value || 'Usuario';
    const data = {usuario:n, fecha:new Date().toISOString(), semana:semanaActual, anio:anioActual, progs, laboresCustom};
    const b = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b);
    a.download = `Programa_Semana${semanaActual}_${anioActual}_${n.replace(/\s+/g,'_')}.json`; a.click();
    showToast('Guardado', `Semana ${semanaActual} guardada`, 'success');
}

function cargarArchivo(e) {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
        try {
            const d = JSON.parse(ev.target.result);
            progs = d.progs||[]; laboresCustom = d.laboresCustom||[];
            if (d.usuario) document.getElementById('userName').value = d.usuario;
            historial = [JSON.stringify({ progs, laboresCustom })];
            historialPos = 0;
            actualizarBotonesHistorial();
            actualizarSemana();
            showToast('Cargado', `${progs.length} labores de Semana ${d.semana||'?'}`, 'success');
        } catch(err) { showToast('Error', 'Archivo inv√°lido', 'error'); }
    };
    r.readAsText(f); e.target.value = '';
}

function exportarExcel() {
    if (!progs.length) { showToast('Vac√≠o', 'No hay datos', 'warning'); return; }
    const dup = detectarDuplicados(), { obsoletas } = detectarObsoletas(), inc = detectarIncompletos(), sinP = detectarSinPersonal();
    if (dup.size > 0) { showToast('Error', `${dup.size} duplicadas`, 'error'); return; }
    if (obsoletas.size > 0) { showToast('Error', `${obsoletas.size} desactualizadas`, 'error'); return; }
    if (inc.size > 0) { showToast('Error', `${inc.size} incompletas`, 'error'); return; }
    if (sinP.size > 0) { showToast('Error', `${sinP.size} sin personal`, 'error'); return; }
    
    const h = ['Fecha','Turno','Fundo','Cultivo','Area','Grupo Labor','Labor','Cantidad','Es Nueva'];
    let csv = '\uFEFF' + h.join(';') + '\n';
    progs.forEach(p => {
        diasSemana.forEach(d => {
            const c = (p.dias && p.dias[d.nom])||0;
            if (c > 0) csv += [d.str, p.turno||'DIA', p.fundo, p.cultivo, p.area, p.grupo, p.labor, c, p.esNueva?'SI':'NO'].join(';')+'\n';
        });
    });
    const b = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b);
    a.download = `Programa_Semana${semanaActual}_${anioActual}.csv`; a.click();
    showToast('Exportado', 'Excel generado', 'success');
}

// ========== BUSCADOR ==========
function toggleSearch() {
    const box = document.getElementById('searchBox');
    if (!box.classList.contains('show')) {
        const fundos = [...new Set(MAESTRO.map(m => m.Fundo))].filter(Boolean).sort();
        document.getElementById('searchFundo').innerHTML = '<option value="">-- Todos --</option>' + fundos.map(f => `<option>${f}</option>`).join('');
        document.getElementById('searchArea').innerHTML = '<option value="">-- Todas --</option>';
        document.getElementById('searchText').value = '';
        document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#64748b;padding:20px;">Ingrese filtros</td></tr>';
    }
    box.classList.toggle('show');
    if (box.classList.contains('show')) document.getElementById('searchText').focus();
}

function updateSearchFilters() {
    const fundo = document.getElementById('searchFundo').value;
    const areas = fundo ? [...new Set(MAESTRO.filter(m => m.Fundo === fundo).map(m => m.AREA))].filter(Boolean).sort() : [...new Set(MAESTRO.map(m => m.AREA))].filter(Boolean).sort();
    document.getElementById('searchArea').innerHTML = '<option value="">-- Todas --</option>' + areas.map(a => `<option>${a}</option>`).join('');
    buscarLabores();
}

function buscarLabores() {
    const fundo = document.getElementById('searchFundo').value;
    const area = document.getElementById('searchArea').value;
    const texto = document.getElementById('searchText').value.toLowerCase().trim();
    
    if (!fundo && !area && !texto) {
        document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#64748b;padding:20px;">Ingrese filtros</td></tr>';
        return;
    }
    
    let res = MAESTRO.filter(m => {
        if (fundo && m.Fundo !== fundo) return false;
        if (area && m.AREA !== area) return false;
        if (texto && !m.Labor?.toLowerCase().includes(texto)) return false;
        return true;
    });
    
    const total = res.length;
    res = res.slice(0, 50);
    window.searchResultados = res;
    
    if (!res.length) {
        document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#64748b;padding:20px;">Sin resultados</td></tr>';
        document.getElementById('searchCount').textContent = '0';
        return;
    }
    
    let html = '';
    res.forEach((m, idx) => {
        html += `<tr><td>${m.Fundo||'-'}</td><td>${m.CULTIVO||m.Cultivo||'-'}</td><td>${m.AREA||'-'}</td><td>${m['Grupo Labor']||'-'}</td><td><strong>${m.Labor||'-'}</strong></td><td style="font-size:7px;">${m.CodCentroCosto||'-'}</td><td><button class="btn-add" onclick="agregarDesdeSearch(${idx})">+ Agregar</button></td></tr>`;
    });
    document.getElementById('searchResultsBody').innerHTML = html;
    document.getElementById('searchCount').textContent = total > 50 ? `50 de ${total}` : `${total}`;
}

function agregarDesdeSearch(idx) {
    const m = window.searchResultados[idx];
    if (!m) return;
    progs.push({ id: Date.now(), fundo: m.Fundo||'', cultivo: m.CULTIVO||m.Cultivo||'', area: m.AREA||'', grupo: m['Grupo Labor']||'', labor: m.Labor||'', cc: m.CodCentroCosto||'', turno: 'DIA', dias: {}, esNueva: false });
    render();
    showToast('Agregada', `"${m.Labor}"`, 'success');
}

// ========== NAVEGACI√ìN CON TECLADO ==========
function navegarInput(event, row, col) {
    const key = event.key;
    
    // Solo procesar flechas, Enter y Tab
    if (!['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp', 'Enter', 'Tab'].includes(key)) {
        return;
    }
    
    event.preventDefault();
    event.stopPropagation();
    
    // Calcular nueva posici√≥n
    let newRow = row;
    let newCol = col;
    
    if (key === 'ArrowRight' || (key === 'Tab' && !event.shiftKey)) {
        if (col < 6) newCol = col + 1;
    } else if (key === 'ArrowLeft' || (key === 'Tab' && event.shiftKey)) {
        if (col > 0) newCol = col - 1;
    } else if (key === 'ArrowDown' || key === 'Enter') {
        if (row < progs.length - 1) newRow = row + 1;
    } else if (key === 'ArrowUp') {
        if (row > 0) newRow = row - 1;
    }
    
    // Buscar y enfocar el nuevo input
    const newInput = document.querySelector(`input.day-input[data-row="${newRow}"][data-col="${newCol}"]`);
    if (newInput) {
        newInput.focus();
        newInput.select();
    }
}

function actualizarTotalesRapido() {
    let totalGen = 0;
    progs.forEach(p => DIAS.forEach(d => { totalGen += (p.dias && p.dias[d]) || 0; }));
    document.getElementById('statPersonal').textContent = totalGen;
    guardarEnLocalSilencioso();
}

function guardarEnLocalSilencioso() {
    const data = { 
        progs, 
        laboresCustom, 
        semana: semanaActual, 
        anio: anioActual, 
        usuario: document.getElementById('userName').value,
        fecha: new Date().toISOString()
    };
    localStorage.setItem('asa_programacion', JSON.stringify(data));
}
</script>
</body>
</html>
